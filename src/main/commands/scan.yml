description: Detect bugs and vulnerabilities
parameters:
  sonar_token_variable_name:
    description: the name of the environment variable where the SonarCloud API token is stored
    default: SONAR_TOKEN
    type: env_var_name
  cache_version:
    description: increment this value if the cache is corrupted and you want to start with a clean cache
    default: 1
    type: integer
  project_root:
    description: the root of the project that should be analyzed (relative to the root directory of the repository)
    default: .
    type: string
  executor_os:
    description: |
      Specify the OS of the executor. Supported options are: linux, macosx, or any.
      If `any` is specified, please ensure your system already has a recent Java JRE installed.
    default: "linux"
    type: enum
    enum: ["linux", "macosx", "any"]
steps:
  - run:
      name: Create cache directory if it doesn't exist
      command: mkdir -p /tmp/cache/scanner
  - restore_cache:
      keys:
        - v<<parameters.cache_version>>-sonarcloud-scanner-5.0.1.3006
  - run:
      name: SonarCloud
      command: |
        set -e
        VERSION=5.0.1.3006
        SONAR_TOKEN=$<<parameters.sonar_token_variable_name>>
        SCANNER_DIRECTORY=/tmp/cache/scanner
        export SONAR_USER_HOME=$SCANNER_DIRECTORY/.sonar
        OS=<<parameters.executor_os>>
        echo $SONAR_USER_HOME

        if [[ "$OS" = "any" ]]; then
          SCANNER_FILENAME=sonar-scanner-cli-$VERSION
        else
          SCANNER_FILENAME=sonar-scanner-cli-$VERSION-$OS
        fi

        if [[ ! -x "$SCANNER_DIRECTORY/$SCANNER_FILENAME/bin/sonar-scanner" ]]; then
          SCANNER_BASE_URL=https://binaries.sonarsource.com/Distribution/sonar-scanner-cli
          curl -Ol $SCANNER_BASE_URL/$SCANNER_FILENAME.zip
          unzip -qq -o $SCANNER_FILENAME.zip -d $SCANNER_DIRECTORY
        fi

        chmod +x $SCANNER_DIRECTORY/$SCANNER_FILENAME/bin/sonar-scanner
        if [[ -x "$SCANNER_DIRECTORY/$SCANNER_FILENAME/jre/bin/java" ]]; then
          chmod +x $SCANNER_DIRECTORY/$SCANNER_FILENAME/jre/bin/java
        fi

        cd <<parameters.project_root>>
        $SCANNER_DIRECTORY/$SCANNER_FILENAME/bin/sonar-scanner
      environment:
        SONARQUBE_SCANNER_PARAMS: '{"sonar.host.url":"https://sonarcloud.io"}'
  - save_cache:
      key: v<<parameters.cache_version>>-sonarcloud-scanner-5.0.1.3006
      paths: /tmp/cache/scanner
